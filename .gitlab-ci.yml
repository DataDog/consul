variables:
  CURRENT_CI_IMAGE: 1

stages:
  - ci-image
  - test
  - release
  - deb

ci-image:
  stage: ci-image
  when: manual
  except: [ tags, schedules ]
  tags: [ "runner:docker", "size:large" ]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
  script:
    - echo 'RUN apt-get update && apt-get install -y --no-install-recommends zip awscli && rm -rf /var/lib/apt/lists/*' >> build-support/docker/Build-Go.dockerfile
    - docker build --tag 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/consul:$CURRENT_CI_IMAGE - < build-support/docker/Build-Go.dockerfile
    - docker push 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/consul:$CURRENT_CI_IMAGE

test:
  tags: [ "runner:main", "size:2xlarge" ]
  when: manual # CI doesn't work currently
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/consul:$CURRENT_CI_IMAGE
  stage: test
  script:
    - rm -rf /go/src/github.com/hashicorp/consul
    - cp -a /go/src/github.com/DataDog/consul /go/src/github.com/hashicorp/consul
    - cd /go/src/github.com/hashicorp/consul
    - make test

release:
  tags: [ "runner:main", "size:2xlarge" ]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/consul:$CURRENT_CI_IMAGE
  stage: release
  only:
    - tags # needs to be the format v1.3.1-XXXX (-dd-2 for instance)
  script:
    - rm -rf /go/src/github.com/hashicorp/consul
    - cp -a /go/src/github.com/DataDog/consul /go/src/github.com/hashicorp/consul
    - cd /go/src/github.com/hashicorp/consul
    - export PRERELEASE=$(echo $CI_COMMIT_TAG | cut -d '-' -f2-)
    - sed -i "s/VersionPrerelease = \".*\"/VersionPrerelease = \"$PRERELEASE\"/" version/version.go
    - make version
    - make linux
    - cd pkg/bin/linux_amd64
    - zip consul_${CI_COMMIT_TAG}_linux_amd64.zip consul
    - aws s3 cp ./consul_${CI_COMMIT_TAG}_linux_amd64.zip s3://devops-public/consul/

deb:
  tags: [ "runner:docker", "size:large" ]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
  stage: deb
  only:
    - tags # needs to be the format v1.3.1-XXXX (-dd-2 for instance)
  script:
    - docker run -v /go/src/github.com/DataDog/consul/fpm-recipe:/recipe -w /recipe dpirotte/fpm-cookery:trusty fpm-cook
